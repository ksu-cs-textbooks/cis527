<!doctype html><html lang=en-us dir=ltr itemscope itemtype=http://schema.org/Article><head><meta charset=utf-8><meta name=viewport content="height=device-height,width=device-width,initial-scale=1,minimum-scale=1"><meta name=generator content="Hugo 0.128.0"><meta name=generator content="Relearn 6.0.0"><meta name=description content="Note This portion is no longer part of the Lab 4 assignment, but I left it here because it is interesting to know that it can be done. –Russ
YouTube Video Resources How to Configure Ubuntu Linux Server as a Domain Controller with Samba-tool by Jack Wallen on TechRepublic Samba Not Starting on Ubuntu Server 16.10 from StackExchange How to Disable Systemd-resolved in Ubuntu from AskUbuntu Video Transcript In this video, I’ll show you how to set up an Ubuntu VM to act as a Windows Active Directory Domain Controller using Samba."><meta name=author content="Russell Feldhausen"><meta name=twitter:card content="summary"><meta name=twitter:title content="Windows Client on Linux Domain :: CIS 527 Textbook"><meta name=twitter:description content="Note This portion is no longer part of the Lab 4 assignment, but I left it here because it is interesting to know that it can be done. –Russ
YouTube Video Resources How to Configure Ubuntu Linux Server as a Domain Controller with Samba-tool by Jack Wallen on TechRepublic Samba Not Starting on Ubuntu Server 16.10 from StackExchange How to Disable Systemd-resolved in Ubuntu from AskUbuntu Video Transcript In this video, I’ll show you how to set up an Ubuntu VM to act as a Windows Active Directory Domain Controller using Samba."><meta property="og:url" content="https://textbooks.cs.ksu.edu/cis527/4-directory-services/10-windows-client-on-linux-domain/"><meta property="og:site_name" content="CIS 527 Textbook"><meta property="og:title" content="Windows Client on Linux Domain :: CIS 527 Textbook"><meta property="og:description" content="Note This portion is no longer part of the Lab 4 assignment, but I left it here because it is interesting to know that it can be done. –Russ
YouTube Video Resources How to Configure Ubuntu Linux Server as a Domain Controller with Samba-tool by Jack Wallen on TechRepublic Samba Not Starting on Ubuntu Server 16.10 from StackExchange How to Disable Systemd-resolved in Ubuntu from AskUbuntu Video Transcript In this video, I’ll show you how to set up an Ubuntu VM to act as a Windows Active Directory Domain Controller using Samba."><meta property="og:locale" content="en-us"><meta property="og:type" content="article"><meta property="article:section" content="Directory Services"><meta property="article:modified_time" content="2020-05-11T16:59:35-05:00"><meta itemprop=name content="Windows Client on Linux Domain :: CIS 527 Textbook"><meta itemprop=description content="Note This portion is no longer part of the Lab 4 assignment, but I left it here because it is interesting to know that it can be done. –Russ
YouTube Video Resources How to Configure Ubuntu Linux Server as a Domain Controller with Samba-tool by Jack Wallen on TechRepublic Samba Not Starting on Ubuntu Server 16.10 from StackExchange How to Disable Systemd-resolved in Ubuntu from AskUbuntu Video Transcript In this video, I’ll show you how to set up an Ubuntu VM to act as a Windows Active Directory Domain Controller using Samba."><meta itemprop=dateModified content="2020-05-11T16:59:35-05:00"><meta itemprop=wordCount content="1310"><title>Windows Client on Linux Domain :: CIS 527 Textbook</title>
<link href=https://textbooks.cs.ksu.edu/cis527/4-directory-services/10-windows-client-on-linux-domain/ rel=canonical type=text/html title="Windows Client on Linux Domain :: CIS 527 Textbook"><link href=/cis527/4-directory-services/10-windows-client-on-linux-domain/index.xml rel=alternate type=application/rss+xml title="Windows Client on Linux Domain :: CIS 527 Textbook"><link href=/cis527/4-directory-services/10-windows-client-on-linux-domain/tele.html rel=alternate type=text/html title="Windows Client on Linux Domain :: CIS 527 Textbook"><link href=/cis527/4-directory-services/10-windows-client-on-linux-domain/embed.html rel=alternate type=text/html title="Windows Client on Linux Domain :: CIS 527 Textbook"><link href=/cis527/css/fontawesome-all.min.css?1728073625 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=/cis527/css/fontawesome-all.min.css?1728073625 rel=stylesheet></noscript><link href=/cis527/css/nucleus.css?1728073625 rel=stylesheet><link href=/cis527/css/auto-complete.css?1728073625 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=/cis527/css/auto-complete.css?1728073625 rel=stylesheet></noscript><link href=/cis527/css/perfect-scrollbar.min.css?1728073625 rel=stylesheet><link href=/cis527/css/fonts.css?1728073625 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=/cis527/css/fonts.css?1728073625 rel=stylesheet></noscript><link href=/cis527/css/theme.css?1728073625 rel=stylesheet><link href=/cis527/css/theme-auto.css?1728073625 rel=stylesheet id=R-variant-style><link href=/cis527/css/chroma-auto.css?1728073625 rel=stylesheet id=R-variant-chroma-style><link href=/cis527/css/variant.css?1728073625 rel=stylesheet><link href=/cis527/css/print.css?1728073625 rel=stylesheet media=print><link href=/cis527/css/format-print.css?1728073625 rel=stylesheet><script src=/cis527/js/variant.js?1728073625></script><script>window.relearn=window.relearn||{},window.relearn.relBasePath="../..",window.relearn.relBaseUri="../../..",window.relearn.absBaseUri="https://textbooks.cs.ksu.edu/cis527",window.index_js_url="/cis527/index.search.js",window.variants&&variants.init(["auto","light-theme","dark-theme"]),window.T_Copy_to_clipboard=`Copy to clipboard`,window.T_Copied_to_clipboard=`Copied to clipboard!`,window.T_Copy_link_to_clipboard=`Copy link to clipboard`,window.T_Link_copied_to_clipboard=`Copied link to clipboard!`,window.T_Reset_view=`Reset view`,window.T_View_reset=`View reset!`,window.T_No_results_found=`No results found for "{0}"`,window.T_N_results_found=`{1} results found for "{0}"`</script><link href=/cis527/css/custom.css?1728073625 rel=stylesheet></head><body class="mobile-support print disableInlineCopyToClipboard" data-url=/cis527/4-directory-services/10-windows-client-on-linux-domain/><div id=R-body class=default-animation><div id=R-body-overlay></div><nav id=R-topbar><div class=topbar-wrapper><div class=topbar-sidebar-divider></div><div class="topbar-area topbar-area-start" data-area=start><div class="topbar-button topbar-button-sidebar" data-content-empty=disable data-width-s=show data-width-m=hide data-width-l=hide><button class=topbar-control onclick=toggleNav() type=button title="Menu (CTRL+ALT+n)"><i class="fa-fw fas fa-bars"></i></button></div></div><ol class="topbar-breadcrumbs breadcrumbs highlightable" itemscope itemtype=http://schema.org/BreadcrumbList><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><a itemprop=item href=/cis527/4-directory-services/><span itemprop=name>Directory Services</span></a><meta itemprop=position content="1">&nbsp;>&nbsp;</li><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><span itemprop=name>Windows Client on Linux Domain</span><meta itemprop=position content="2"></li></ol><div class="topbar-area topbar-area-end" data-area=end><div class="topbar-button topbar-button-prev" data-content-empty=disable data-width-s=show data-width-m=show data-width-l=show><a class=topbar-control href=/cis527/4-directory-services/09-linux-client-on-windows-domain/ title="Linux Client on Windows Domain (🡐)"><i class="fa-fw fas fa-chevron-left"></i></a></div><div class="topbar-button topbar-button-next" data-content-empty=disable data-width-s=show data-width-m=show data-width-l=show><a class=topbar-control href=/cis527/4-directory-services/11-adds-netbios/ title="AD and NETBIOS Names (🡒)"><i class="fa-fw fas fa-chevron-right"></i></a></div></div></div></nav><div id=R-main-overlay></div><main id=R-body-inner class="highlightable default" tabindex=-1><div class=flex-block-wrapper><article class=default><header class=headline></header><h1 id=windows-client-on-linux-domain>Windows Client on Linux Domain</h1><div class="box notices cstyle note"><div class=box-label><i class="fa-fw fas fa-exclamation-circle"></i> Note</div><div class=box-content><p><em>This portion is no longer part of the Lab 4 assignment, but I left it here because it is interesting to know that it can be done. &ndash;Russ</em></p></div></div><a href="https://www.youtube.com/watch?v=t3ESN_EXGGw">YouTube Video</a><h4 id=resources>Resources</h4><ul><li><a href=https://www.techrepublic.com/article/how-to-configure-ubuntu-linux-server-as-a-domain-controller-with-samba-tool/ rel=external target=_blank>How to Configure Ubuntu Linux Server as a Domain Controller with Samba-tool</a> by Jack Wallen on TechRepublic</li><li><a href=https://unix.stackexchange.com/questions/341226/samba-not-starting-on-ubuntu-server-16-10 rel=external target=_blank>Samba Not Starting on Ubuntu Server 16.10</a> from StackExchange</li><li><a href=https://askubuntu.com/questions/907246/how-to-disable-systemd-resolved-in-ubuntu rel=external target=_blank>How to Disable Systemd-resolved in Ubuntu</a> from AskUbuntu</li></ul><h4 id=video-transcript>Video Transcript</h4><p>In this video, I&rsquo;ll show you how to set up an Ubuntu VM to act as a Windows Active Directory Domain Controller using Samba. Unfortunately, at this time it is not straightforward at all to use OpenLDAP as the server, hence the decision to use Samba instead. This is a much more complicated process than adding Ubuntu as a client to an existing Active Directory Domain, but I feel that it is important to see that it is indeed possible. This is helpful if your organization is primarily Linux-based, but you wish to include a few Windows clients on the network as well.</p><p>For this example, I&rsquo;m using the Ubuntu VM labelled <strong>Client</strong> from earlier in this lab. I&rsquo;ve created a snapshot to store the work done previously to add it to an OpenLDAP domain, but now I&rsquo;ve restored the snapshot labelled &ldquo;Before Lab 4&rdquo; and will use that snapshot to create a Samba server. The reason I am doing this on the VM labelled <strong>Client</strong> and not the one labelled <strong>Server</strong> is because the Samba installation will directly conflict with Bind9, OpenLDAP, and many other tools we&rsquo;ve already installed on the server. So, this allows us to avoid any conflicts with those tools.</p><p>For the client, I have restored my Windows 10 VM to a snapshot taken before it was added to my Active Directory Domain. Remember that you&rsquo;ll need to create this snapshot before you start the Lab 4 assignment, or else you may need to create a new VM for this activity.</p><p>Finally, I&rsquo;ll generally be following the great guide by Jack Wallen that is linked in the resources section below this video, but I&rsquo;ll be making a few minor changes to match our environment and clarifying a few things that he leaves out.</p><p>Before we begin, we&rsquo;ll need to set a static IP on this system, since it will be acting as a server. I&rsquo;m going to use the IP ending in <code>45</code> in my local subnet. For the DNS entries, we&rsquo;ll also need to set the first entry to be this system itself, just like we did with the Windows Domain Controller. The second DNS entry can be the VMware router or any other valid DNS server.</p><p>First, we&rsquo;ll need to install Samba as well as a few supporting tools:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo apt update
</span></span><span class=line><span class=cl>sudo apt install samba libpam-winbind smbclient</span></span></code></pre></div><p>This will install many supporting packages as well.</p><p>Next, we need to make a few edits to our <code>hosts</code> file as well as update our hostname. This will help Samba find the correct settings as we configure it in a later step. First, let&rsquo;s edit the <code>hosts</code> file:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo nano /etc/hosts</span></span></code></pre></div><p>I&rsquo;ll need to add or edit a few entries at the top of this file. Here&rsquo;s what mine currently looks like:</p><div class=highlight><pre tabindex=0><code>127.0.0.1       localhost.localdomain
127.0.1.1       dc
192.168.40.41   localhost
192.168.40.41   smbrussfeld.cis527.cs.ksu.edu       smbrussfeld
192.168.40.41   dc.smbrussfeld.cis527.cs.ksu.edu    dc</code></pre></div><p>The first line is updated to be <code>localhost.localdomain</code>, just to make it clear that that IP address is for the loopback adapter. The second line gives the new hostname for this system. In this case, I&rsquo;m calling it <code>dc</code> for domain controller. The third line redirects the <code>localhost</code> domain name to the external IP address. Finally, the fourth and fifth lines give the name of the domain as well as the fully qualified domain name for this system, respectively.</p><p>To go along with this change, we&rsquo;ll edit the <code>hostname</code> file as well:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo nano /etc/hostname</span></span></code></pre></div><p>It should now be the same as the hostname used in the <code>hosts</code> file:</p><div class=highlight><pre tabindex=0><code>dc</code></pre></div><p>Finally, we&rsquo;ll need to restart the computer for these changes to take effect.</p><p>Once it has restarted, we&rsquo;ll need to remove any existing Samba configuration files and database files.</p><p>Thankfully, there are some great commands for finding the location of those files. First, you can find the location of the config file using this command:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>smbd -b <span class=p>|</span> grep <span class=s2>&#34;CONFIGFILE&#34;</span></span></span></code></pre></div><p>It is usually at <code>/etc/samba/smb.conf</code>. So, to delete it, you&rsquo;ll use:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo rm -f /etc/samba/smb.conf</span></span></code></pre></div><p>Next, you can find the locations of all database files using this command:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>smbd -b <span class=p>|</span> egrep <span class=s2>&#34;LOCKDIR|STATEDIR|CACHEDIR|PRIVATE_DIR&#34;</span></span></span></code></pre></div><p>It should give you four different directory paths. So, for each of those directories, you&rsquo;ll need to enter that directory, then delete all files with the <code>.tdb</code> and <code>.ldb</code> file extensions. So, for the first one, you could use these commands:</p><div class=highlight><pre tabindex=0><code>cd /var/run/samba
sudo rm -f *.tdb *.ldb</code></pre></div><p>Repeat that process for the other three directories to make sure they are all clear.</p><p>Once that is done, it is time to create our new domain. We&rsquo;ll use the <code>samba-tool</code> command to do this in interactive mode:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo samba-tool domain provision --use-rfc2307 --interactive</span></span></code></pre></div><p>First, it will ask you for the realm. For this example, I&rsquo;ll use the name <code>smbrussfeld.cis527.cs.ksu.edu</code>. Following that, it should ask you for the NetBIOS name of your domain. The default should be <code>smbrussfeld</code>, which is fine. You can also accept the defaults of <code>dc</code> for the server role, and <code>SAMBA_INTERNAL</code> for the DNS backend. For the DNS forwarder address, you can use the VMware router&rsquo;s IP address, or any other valid DNS server address from Lab 3. Finally, you&rsquo;ll need to enter a password for the Administrator account. I&rsquo;ll use the same password as always.</p><p>Once you&rsquo;ve entered that information, your domain will be configured. Now, we&rsquo;ll need to add a user to Samba and enable it using the following commands:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo smbpasswd -a &lt;username&gt;
</span></span><span class=line><span class=cl>sudo smbpasswd -e &lt;username&gt;</span></span></code></pre></div><p>Next, we&rsquo;ll need to disable the <code>systemd-resolved</code> service. This service is installed by default on Ubuntu 18.04, and is responsible for caching local DNS queries. However, since it binds to port 53, it will prevent our Samba server from binding to that port. To disable it, we&rsquo;ll use the following commands:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo systemctl disable systemd-resolved
</span></span><span class=line><span class=cl>sudo systemctl stop systemd-resolved</span></span></code></pre></div><p>We&rsquo;ll also need to disable the existing Samba services, and enable the Samba Domain Controller service:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo systemctl disable nmbd
</span></span><span class=line><span class=cl>sudo systemctl stop nmbd
</span></span><span class=line><span class=cl>sudo systemctl disable smbd
</span></span><span class=line><span class=cl>sudo systemctl stop smbd
</span></span><span class=line><span class=cl>sudo systemctl unmask samba-ad-dc
</span></span><span class=line><span class=cl>sudo systemctl <span class=nb>enable</span> samba-ad-dc
</span></span><span class=line><span class=cl>sudo systemctl start samba-ad-dc</span></span></code></pre></div><p>Lastly, we&rsquo;ll need to replace any existing Kerberos configuration file with the one created by Samba. So, you&rsquo;ll perform these commands to delete the existing file (if any) and create a symbolic link to the one from Samba.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo mv /etc/krb5.conf /etc/krb5.conf.orig
</span></span><span class=line><span class=cl>​sudo ln -sf /var/lib/samba/private/krb5.conf /etc/krb5.conf</span></span></code></pre></div><p>If you get an error from the first command, you can safely ignore it.</p><p>Finally, if everything is configured correctly, we can query our domain using the <code>smbclient</code> command:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>smbclient -L localhost -U%</span></span></code></pre></div><p>Hopefully you should get output from that command giving information about your domain. If not, you&rsquo;ll probably need to review the Samba log file stored in <code>/var/log/samba/log.samba</code> to see what the error is.</p><p>If everything is working correctly, you can then add your Windows 10 VM to the domain. First, as with any client I wish to add to a domain, I&rsquo;ll need to set a static DNS entry to point to the domain controller itself. For the second entry, I&rsquo;ll just use the VMware router as always. Then, I can add it to the domain following the instructions in the earlier video.</p><p>After a reboot, it should allow you to log in as the domain user created earlier.</p><p>It is quite a process, but hopefully this demonstrates what it takes to create an Active Directory Domain using Samba. I highly recommend that you try this process at least once, even if you don&rsquo;t plan on completing it as part of Lab 4, just to see how it all works together.</p><footer class=footline></footer></article></div></main><div class=git-footer><p class=theme-version-footer>6.0.0</p><p>Last modified by:
<i class='fas fa-user'></i> Russell Feldhausen
<i class='fas fa-calendar'></i> <a href=https://github.com/ksu-cs-textbooks/cis527/commit/4dc5faa8f59ee7a3ad5fe1ebc3913f15a061d0de>May 11, 2020</a></p></div></div><script src=/cis527/js/clipboard.min.js?1728073625 defer></script><script src=/cis527/js/perfect-scrollbar.min.js?1728073625 defer></script><script src=/cis527/js/theme.js?1728073625 defer></script></body></html>