<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="height=device-height, width=device-width, initial-scale=1.0, minimum-scale=1.0">
    <meta name="generator" content="Hugo 0.101.0">
    <meta name="generator" content="Relearn 5.0.3+tip">




	
	
			

	
	
			

	
	
			
			

	
	
			
			

	
	
			
			

	
	
			
			

	
	
			

	
	
			

	
	
			
			

	
	
			
			
			
			

	
	
			
			

	
	
			
			

	
	
			
			
			

	
	
			

	
	
			
			

	
	
			
			

	
	
			
			

	
	
			
			

	
	
			
			

	
	
			
			

	
	
			
			

	
	
			
			

	
	
			
			

	
	
			
			

	
	
			
			

	
	
			
			

	
	
			
			

	
	
			
			

	
	
			
			

	
	
			
			

	
	
			
			

	
	
			
			

	
	
			
			

	
	
			
			

	
	
			
			

	
	
			
			

	
	
			
			

	
	
			
			

	
	
			
			

	
	
			
			

	
	
			
			

	
	
			
			

	
	
			
			

	
	
			
			

	
	
			
			

	
	
			
			
			

	
	
			

	
	
			
			

	
	
			
			

	
	
			
			

	
	
			
			

	
	
			
			

	
	
			
			

	
	
			
			

	
	
			
			

	
	
			
			

	
	
			
			

	
	
			
			

	
	
			
			

	
	
			
			

	
	
			
			

	
	
			
			

	
	
			
			
			

	
	
			

	
	
			
			

	
	
			
			

	
	
			
			

	
	
			
			

	
	
			
			

	
	
			
			

	
	
			
			

	
	
			
			

	
	
			
			

	
	
			
			

	
	
			
			

	
	
			
			

	
	
			
			

	
	
			
			

	
	
			
			

	
	
			
			

	
	
			
			

	
	
			
			

	
	
			
			

	
	
			
			

	
	
			
			

	
	
			
			

	
	
			
			

	
	
			
			

	
	
			
			

	
	
			
			

	
	
			
			

	
	
			
			

	
	
			
			

	
	
			
			
			

	
	
			

	
	
			
			

	
	
			
			

	
	
			
			

	
	
			
			

	
	
			
			

	
	
			
			

	
	
			
			

	
	
			
			

	
	
			
			

	
	
			
			

	
	
			
			

	
	
			
			

	
	
			
			

	
	
			
			

	
	
			
			
			

	
	
			

	
	
			
			

	
	
			
			

	
	
			
			

	
	
			
			

	
	
			
			

	
	
			
			

	
	
			
			

	
	
			
			

	
	
			
			

	
	
			
			

	
	
			
			

	
	
			
			

	
	
			
			
			

	
	
			

	
	
			
			

	
	
			
			

	
	
			
			

	
	
			
			

	
	
			
			

	
	
			
			

	
	
			
			

	
	
			
			

	
	
			
			

	
	
			
			

	
	
			
			

	
	
			
			

	
	
			
			

	
	
			
			

	
	
			
			

	
	
			
			

	
	
			
			
			

	
	
			

	
	
			
			

	
	
			
			

	
	
			
			

	
	
			
			

	
	
			
			

	
	
			
			

	
	
			
			

	
	
			
			

	
	
			
			

	
	
			
			

	
	
			
			

	
	
			
			

	
	
			
			

	
	
			
			

	
	
			
			

	
	
			
			

	
	
			
			
			

	
	
			

	
	
			
			

	
	
			
			

	
	
			
			

	
	
			
			

	
	
			
			

	
	
			
			

	
	
			
			

	
	
			
			

	
	
			
			

	
	
			
			

	
	
			
			

	
	
			
			

	
	
			
			

	
	
			
			

	
	
			
			
			

	
	
			

	
	
			
			

	
	
			
			
			

	
	
			

	
	
			
			
			

	
	
			

	
	
			
			

	
	
			
			

	
	
			
			

	
	
			
			

	
	
			
			

	
	
			
			

	
	
			
			
			

	
	
			

	
	
			

	
	
			
			
			

	
	
			

	
	
			
			
			

	
	
			

	
	
			
			
			

	
	
			

	
	
			
			
			

	
	
			

	
	
			
			
			

	
	
			

	
	
			
			
			

	
	
			

	
	
			
			
			

	
	
			

	
	
			
			
			

	
	
			

	
	
			

	
	
			
			

	
	
			
			

	
	
			
			

	
	
			
			

	
	
			
			

	
	
			
			

	
	
			
			

	
	
			
			

	
	
			
			

	
	
			
			

	
	
			
			

	
	
			
			
			

	
	
			

	
	
			
			

	
	
			
			

	
	
			
			

	
	
			
			

	
	
			
			

	
	
			
			

	
	
			
			

	
	
			
			

	
	
			
			

	
	
			
			

	
	
			
			

	
	
			
			

	
	
			
			

	
	
			
			

	
	
			
			

	
	
			
			
			

	
	
			

	
	
			

	
	
			
			
			

	
	
			

	
	
			
			
			

	
	
			

	
	
			
			
			

	
	
			

	
	
			
			
			

	
	
			

	
	
			
			
			
			
			
			

	
	
			

	
	
			
			

	
	
			
			

	
	
			
			

	
	
			
			

	
	
			
			

	
	
			
			

	
	
			
			

	
	
			
			

	
	
			
			

	
	
			
			

	
	
			
			

	
	
			
			

	
	
			
			

	
	
			
			

    <meta name="description" content="CIS 527 Textbook">
    <meta name="author" content="Russell Feldhausen">
    <title>Windows Client on Linux Domain :: CIS 527 Textbook</title>
    <link href="https://ksu-cs-textbooks.github.io/cis527/4-directory-services/10-windows-client-on-linux-domain/" rel="canonical" type="text/html" title="CIS 527 Textbook">
    <link href="https://ksu-cs-textbooks.github.io/cis527/4-directory-services/10-windows-client-on-linux-domain/index.xml" rel="alternate" type="application/rss+xml" title="CIS 527 Textbook">
    <link href="https://ksu-cs-textbooks.github.io/cis527/_print/4-directory-services/10-windows-client-on-linux-domain/" rel="alternate" type="text/html" title="CIS 527 Textbook">
    <link href="https://ksu-cs-textbooks.github.io/cis527/4-directory-services/10-windows-client-on-linux-domain/tele.html" rel="alternate" type="text/html" title="CIS 527 Textbook">
    
    <link href="https://ksu-cs-textbooks.github.io/cis527/css/fontawesome-all.min.css?1659468438" rel="stylesheet" media="print" onload="this.media='all';this.onload=null;">
    <link href="https://ksu-cs-textbooks.github.io/cis527/css/featherlight.min.css?1659468438" rel="stylesheet" media="print" onload="this.media='all';this.onload=null;">
    <link href="https://ksu-cs-textbooks.github.io/cis527/css/auto-complete.css?1659468438" rel="stylesheet" media="print" onload="this.media='all';this.onload=null;">
    <noscript>
      <link href="https://ksu-cs-textbooks.github.io/cis527/css/fontawesome-all.min.css?1659468438" rel="stylesheet">
      <link href="https://ksu-cs-textbooks.github.io/cis527/css/featherlight.min.css?1659468438" rel="stylesheet">
      <link href="https://ksu-cs-textbooks.github.io/cis527/css/auto-complete.css?1659468438" rel="stylesheet">
    </noscript>
    <link href="https://ksu-cs-textbooks.github.io/cis527/css/perfect-scrollbar.min.css?1659468438" rel="stylesheet">
    <link href="https://ksu-cs-textbooks.github.io/cis527/css/nucleus.css?1659468438" rel="stylesheet">
    <link href="https://ksu-cs-textbooks.github.io/cis527/css/fonts.css?1659468438" rel="stylesheet" media="print" onload="this.media='all';this.onload=null;">
    <link href="https://ksu-cs-textbooks.github.io/cis527/css/theme.css?1659468438" rel="stylesheet">
    <link href="https://ksu-cs-textbooks.github.io/cis527/css/theme-light-theme.css?1659468438" rel="stylesheet" id="variant-style">
    <link href="https://ksu-cs-textbooks.github.io/cis527/css/ie.css?1659468438" rel="stylesheet">
    <link href="https://ksu-cs-textbooks.github.io/cis527/css/variant.css?1659468438" rel="stylesheet">
    <link href="https://ksu-cs-textbooks.github.io/cis527/css/print.css?1659468438" rel="stylesheet" media="print">
    <script src="https://ksu-cs-textbooks.github.io/cis527/js/variant.js?1659468438"></script>
    <script>
      // hack to let hugo tell us how to get to the root when using relativeURLs, it needs to be called *url= for it to do its magic:
      // https://github.com/gohugoio/hugo/blob/145b3fcce35fbac25c7033c91c1b7ae6d1179da8/transform/urlreplacers/absurlreplacer.go#L72
      var index_url="https://ksu-cs-textbooks.github.io/cis527/index.json";
      var root_url="https://ksu-cs-textbooks.github.io/cis527/";
      var baseUri=root_url.replace(/\/$/, '');
      // translations
      window.T_Copy_to_clipboard = 'Copy to clipboard';
      window.T_Copied_to_clipboard = 'Copied to clipboard!';
      window.T_Copy_link_to_clipboard = 'Copy link to clipboard';
      window.T_Link_copied_to_clipboard = 'Copied link to clipboard!';
      // some further base stuff
      var baseUriFull='https:\/\/ksu-cs-textbooks.github.io\/cis527/';
      variants.init( [ 'light-theme', 'dark-theme' ] );
    </script>
    
    <link href="https://ksu-cs-textbooks.github.io/cis527/css/custom.css?1659468438" rel="stylesheet">
    <script src="https://ksu-cs-textbooks.github.io/cis527/js/jquery.min.js?1659468438" defer></script>

  </head>
  <body class="mobile-support disableInlineCopyToClipboard" data-url="https://ksu-cs-textbooks.github.io/cis527/4-directory-services/10-windows-client-on-linux-domain/embed.html">
    
    <div class="embed">
    
    <div id="body" class="default-animation">
      
      
      <main id="body-inner" class="highlightable default" tabindex="-1">
        <div class="flex-block-wrapper">
          <div id="head-tags">
          </div>
          <article class="default">
    
    

  
  
<div class="box notices cstyle note">
    <div class="box-label"><i class="fa-fw fas fa-exclamation-circle"></i> Note</div>
    <div class="box-content">
<p><em>This portion is no longer part of the Lab 4 assignment, but I left it here because it is interesting to know that it can be done. &ndash;Russ</em></p>
    </div>
</div>

<div style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden;">
  <iframe src="https://www.youtube.com/embed/t3ESN_EXGGw" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border:0;" allowfullscreen title="YouTube Video"></iframe>
</div>

<h4 id="resources">Resources</h4>
<ul>
<li>

<a href="https://www.techrepublic.com/article/how-to-configure-ubuntu-linux-server-as-a-domain-controller-with-samba-tool/" target="_blank" rel="noopener">How to Configure Ubuntu Linux Server as a Domain Controller with Samba-tool</a> by Jack Wallen on TechRepublic</li>
<li>

<a href="https://unix.stackexchange.com/questions/341226/samba-not-starting-on-ubuntu-server-16-10" target="_blank" rel="noopener">Samba Not Starting on Ubuntu Server 16.10</a> from StackExchange</li>
<li>

<a href="https://askubuntu.com/questions/907246/how-to-disable-systemd-resolved-in-ubuntu" target="_blank" rel="noopener">How to Disable Systemd-resolved in Ubuntu</a> from AskUbuntu</li>
</ul>
<h4 id="video-transcript">Video Transcript</h4>
<p>In this video, I&rsquo;ll show you how to set up an Ubuntu VM to act as a Windows Active Directory Domain Controller using Samba. Unfortunately, at this time it is not straightforward at all to use OpenLDAP as the server, hence the decision to use Samba instead. This is a much more complicated process than adding Ubuntu as a client to an existing Active Directory Domain, but I feel that it is important to see that it is indeed possible. This is helpful if your organization is primarily Linux-based, but you wish to include a few Windows clients on the network as well.</p>
<p>For this example, I&rsquo;m using the Ubuntu VM labelled <strong>Client</strong> from earlier in this lab. I&rsquo;ve created a snapshot to store the work done previously to add it to an OpenLDAP domain, but now I&rsquo;ve restored the snapshot labelled &ldquo;Before Lab 4&rdquo; and will use that snapshot to create a Samba server. The reason I am doing this on the VM labelled <strong>Client</strong> and not the one labelled <strong>Server</strong> is because the Samba installation will directly conflict with Bind9, OpenLDAP, and many other tools we&rsquo;ve already installed on the server. So, this allows us to avoid any conflicts with those tools.</p>
<p>For the client, I have restored my Windows 10 VM to a snapshot taken before it was added to my Active Directory Domain. Remember that you&rsquo;ll need to create this snapshot before you start the Lab 4 assignment, or else you may need to create a new VM for this activity.</p>
<p>Finally, I&rsquo;ll generally be following the great guide by Jack Wallen that is linked in the resources section below this video, but I&rsquo;ll be making a few minor changes to match our environment and clarifying a few things that he leaves out.</p>
<p>Before we begin, we&rsquo;ll need to set a static IP on this system, since it will be acting as a server. I&rsquo;m going to use the IP ending in <code>45</code> in my local subnet. For the DNS entries, we&rsquo;ll also need to set the first entry to be this system itself, just like we did with the Windows Domain Controller. The second DNS entry can be the VMware router or any other valid DNS server.</p>
<p>First, we&rsquo;ll need to install Samba as well as a few supporting tools:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo apt update
</span></span><span style="display:flex;"><span>sudo apt install samba libpam-winbind smbclient
</span></span></code></pre></div><p>This will install many supporting packages as well.</p>
<p>Next, we need to make a few edits to our <code>hosts</code> file as well as update our hostname. This will help Samba find the correct settings as we configure it in a later step. First, let&rsquo;s edit the <code>hosts</code> file:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo nano /etc/hosts
</span></span></code></pre></div><p>I&rsquo;ll need to add or edit a few entries at the top of this file. Here&rsquo;s what mine currently looks like:</p>
<pre tabindex="0"><code>127.0.0.1       localhost.localdomain
127.0.1.1       dc
192.168.40.41   localhost
192.168.40.41   smbrussfeld.cis527.cs.ksu.edu       smbrussfeld
192.168.40.41   dc.smbrussfeld.cis527.cs.ksu.edu    dc
</code></pre><p>The first line is updated to be <code>localhost.localdomain</code>, just to make it clear that that IP address is for the loopback adapter. The second line gives the new hostname for this system. In this case, I&rsquo;m calling it <code>dc</code> for domain controller. The third line redirects the <code>localhost</code> domain name to the external IP address. Finally, the fourth and fifth lines give the name of the domain as well as the fully qualified domain name for this system, respectively.</p>
<p>To go along with this change, we&rsquo;ll edit the <code>hostname</code> file as well:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo nano /etc/hostname
</span></span></code></pre></div><p>It should now be the same as the hostname used in the <code>hosts</code> file:</p>
<pre tabindex="0"><code>dc
</code></pre><p>Finally, we&rsquo;ll need to restart the computer for these changes to take effect.</p>
<p>Once it has restarted, we&rsquo;ll need to remove any existing Samba configuration files and database files.</p>
<p>Thankfully, there are some great commands for finding the location of those files. First, you can find the location of the config file using this command:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>smbd -b | grep <span style="color:#e6db74">&#34;CONFIGFILE&#34;</span>
</span></span></code></pre></div><p>It is usually at <code>/etc/samba/smb.conf</code>. So, to delete it, you&rsquo;ll use:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo rm -f /etc/samba/smb.conf
</span></span></code></pre></div><p>Next, you can find the locations of all database files using this command:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>smbd -b | egrep <span style="color:#e6db74">&#34;LOCKDIR|STATEDIR|CACHEDIR|PRIVATE_DIR&#34;</span>
</span></span></code></pre></div><p>It should give you four different directory paths. So, for each of those directories, you&rsquo;ll need to enter that directory, then delete all files with the <code>.tdb</code> and <code>.ldb</code> file extensions. So, for the first one, you could use these commands:</p>
<pre tabindex="0"><code>cd /var/run/samba
sudo rm -f *.tdb *.ldb
</code></pre><p>Repeat that process for the other three directories to make sure they are all clear.</p>
<p>Once that is done, it is time to create our new domain. We&rsquo;ll use the <code>samba-tool</code> command to do this in interactive mode:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo samba-tool domain provision --use-rfc2307 --interactive
</span></span></code></pre></div><p>First, it will ask you for the realm. For this example, I&rsquo;ll use the name <code>smbrussfeld.cis527.cs.ksu.edu</code>. Following that, it should ask you for the NetBIOS name of your domain. The default should be <code>smbrussfeld</code>, which is fine. You can also accept the defaults of <code>dc</code> for the server role, and <code>SAMBA_INTERNAL</code> for the DNS backend. For the DNS forwarder address, you can use the VMware router&rsquo;s IP address, or any other valid DNS server address from Lab 3. Finally, you&rsquo;ll need to enter a password for the Administrator account. I&rsquo;ll use the same password as always.</p>
<p>Once you&rsquo;ve entered that information, your domain will be configured. Now, we&rsquo;ll need to add a user to Samba and enable it using the following commands:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo smbpasswd -a &lt;username&gt;
</span></span><span style="display:flex;"><span>sudo smbpasswd -e &lt;username&gt;
</span></span></code></pre></div><p>Next, we&rsquo;ll need to disable the <code>systemd-resolved</code> service. This service is installed by default on Ubuntu 18.04, and is responsible for caching local DNS queries. However, since it binds to port 53, it will prevent our Samba server from binding to that port. To disable it, we&rsquo;ll use the following commands:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo systemctl disable systemd-resolved
</span></span><span style="display:flex;"><span>sudo systemctl stop systemd-resolved
</span></span></code></pre></div><p>We&rsquo;ll also need to disable the existing Samba services, and enable the Samba Domain Controller service:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo systemctl disable nmbd
</span></span><span style="display:flex;"><span>sudo systemctl stop nmbd
</span></span><span style="display:flex;"><span>sudo systemctl disable smbd
</span></span><span style="display:flex;"><span>sudo systemctl stop smbd
</span></span><span style="display:flex;"><span>sudo systemctl unmask samba-ad-dc
</span></span><span style="display:flex;"><span>sudo systemctl enable samba-ad-dc
</span></span><span style="display:flex;"><span>sudo systemctl start samba-ad-dc
</span></span></code></pre></div><p>Lastly, we&rsquo;ll need to replace any existing Kerberos configuration file with the one created by Samba. So, you&rsquo;ll perform these commands to delete the existing file (if any) and create a symbolic link to the one from Samba.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo mv /etc/krb5.conf /etc/krb5.conf.orig
</span></span><span style="display:flex;"><span>​sudo ln -sf /var/lib/samba/private/krb5.conf /etc/krb5.conf
</span></span></code></pre></div><p>If you get an error from the first command, you can safely ignore it.</p>
<p>Finally, if everything is configured correctly, we can query our domain using the <code>smbclient</code> command:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>smbclient -L localhost -U%
</span></span></code></pre></div><p>Hopefully you should get output from that command giving information about your domain. If not, you&rsquo;ll probably need to review the Samba log file stored in <code>/var/log/samba/log.samba</code> to see what the error is.</p>
<p>If everything is working correctly, you can then add your Windows 10 VM to the domain. First, as with any client I wish to add to a domain, I&rsquo;ll need to set a static DNS entry to point to the domain controller itself. For the second entry, I&rsquo;ll just use the VMware router as always. Then, I can add it to the domain following the instructions in the earlier video.</p>
<p>After a reboot, it should allow you to log in as the domain user created earlier.</p>
<p>It is quite a process, but hopefully this demonstrates what it takes to create an Active Directory Domain using Samba. I highly recommend that you try this process at least once, even if you don&rsquo;t plan on completing it as part of Lab 4, just to see how it all works together.</p>

            <footer class="footline">
            </footer>
          </article>

        </div>
      </main>
    
    
    </div>
    
  </div>
    
    
    
    <script src="https://ksu-cs-textbooks.github.io/cis527/js/clipboard.min.js?1659468438" defer></script>
    <script src="https://ksu-cs-textbooks.github.io/cis527/js/perfect-scrollbar.min.js?1659468438" defer></script>
    <script src="https://ksu-cs-textbooks.github.io/cis527/js/featherlight.min.js?1659468438" defer></script>
    <script src="https://ksu-cs-textbooks.github.io/cis527/js/theme.js?1659468438" defer></script>
    
    <script src="https://ksu-cs-textbooks.github.io/cis527/js/embed-iframe.js?1659468438 defer"></script>
    
    
    
  </body>
</html>
